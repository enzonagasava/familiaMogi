<script setup lang="ts">
import { Link, router } from '@inertiajs/vue3'
import { ButtonTable, Button } from '@/components/ui/button'
import { Pencil, Eye, ArrowRight, ShoppingCart, Check  } from 'lucide-vue-next'
import { computed } from 'vue'
import HeadingSmall from '@/components/ui/header/HeadingSmall.vue'
import axios from 'axios'

const props = defineProps({
  pedidos: {
    type: Array,
    required: true
  },
  status: {
    type: String,
    required: true
  }
})

const pedidosFiltrados = computed(() => {
  return props.pedidos.filter(p => p.status.toLowerCase() === props.status)
})

const formatStatus = (status: string) => {
  if (!status) return ''
  return status.replace(/-/g, ' ')
               .replace(/\b\w/g, l => l.toUpperCase())
}

async function avancarStatus(pedidoId: number) {
  try {
    await axios.put(route('admin.pedidos.avancar.status', pedidoId))
    alert('✅ Pedido atualizado com sucesso!')
    router.reload()
  } catch (e) {
    console.error(e)
    alert('Erro ao avançar o status.')
  }
}
</script>

<template>
  <div class="mb-6 flex items-center justify-between">
    <HeadingSmall
      :title="props.status === 'em-andamento'
        ? 'Pedidos em Andamento'
        : props.status === 'a-caminho'
          ? 'Pedidos a Caminho'
          : 'Pedidos Finalizados'"
    />

    <Link :href="route('admin.pedidos.create')">
      <Button> + Adicionar Novo Pedido </Button>
    </Link>
  </div>

  <div class="overflow-x-auto">
    <table class="min-w-full bg-white rounded-xl shadow">
      <thead class="bg-gray-50">
        <tr>
          <th class="text-center px-6 py-3 text-xs font-medium text-gray-500 uppercase">Cliente</th>
          <th class="text-center px-6 py-3 text-xs font-medium text-gray-500 uppercase">Código Pedido</th>
          <th class="text-center px-6 py-3 text-xs font-medium text-gray-500 uppercase">Valor</th>
          <th class="text-center px-6 py-3 text-xs font-medium text-gray-500 uppercase">Endereço</th>
          <th class="text-center px-6 py-3 text-xs font-medium text-gray-500 uppercase">Plataforma</th>
          <th class="text-center px-6 py-3 text-xs font-medium text-gray-500 uppercase">Status</th>
          <th class="text-center px-6 py-3 text-xs font-medium text-gray-500 uppercase">Data</th>
          <th class="text-center px-6 py-3 text-xs font-medium text-gray-500 uppercase">Ações</th>
        </tr>
      </thead>

      <tbody class="divide-y divide-gray-200">
        <tr
          v-for="pedido in pedidosFiltrados"
          :key="pedido.id"
          class="hover:bg-gray-50 transition-colors"
        >
          <td class="text-center">{{ pedido.cliente }}</td>
          <td class="text-center">{{ pedido.cod_pedido }}</td>
          <td class="text-center">{{ pedido.valor }}</td>
          <td class="text-center">{{ pedido.endereco }}</td>
          <td class="text-center">{{ pedido.plataforma }}</td>
          <td class="text-center capitalize">
            <span
              :class="[
                'px-3 py-1 rounded-full text-xs font-semibold',
                pedido.status.toLowerCase() === 'em-andamento'
                ? 'bg-yellow-100 text-yellow-800'
                : pedido.status.toLowerCase() === 'a-caminho'
                  ? 'bg-blue-100 text-blue-800'
                  : 'bg-green-100 text-green-800'
              ]"
            >
              {{ formatStatus(pedido.status) }}
            </span>
          </td>
          <td class="text-center">{{ pedido.created_at_formatted }}</td>
          <td class="px-6 py-4 text-right text-sm font-medium flex justify-end gap-3">
            <Link :href="route('admin.pedidos.edit', pedido.id)">
              <ButtonTable
                :icon="Pencil"
                label="Editar"
                variant="ghost"
                class="text-indigo-600 hover:text-indigo-900"
              />
            </Link>
            <Link :href="route('admin.pedidos.view', pedido.id)">
            <ButtonTable
              :icon="Eye"
              label="Ver"
              variant="ghost"
              class="text-gray-700 hover:text-gray-900"
            />
            </Link>
            <ButtonTable
              v-if="pedido.status !== 'finalizado'"
              :icon="pedido.status.toLowerCase() === 'em-andamento' ? ShoppingCart : Check"
              :label="pedido.status === 'em-andamento' ? 'Enviar' : 'Finalizar'"
              variant="ghost"
              class="text-green-600 hover:text-green-900"
              @click="avancarStatus(pedido.id)"
            />
          </td>
        </tr>

        <tr v-if="pedidosFiltrados.length === 0">
          <td colspan="8" class="py-6 text-center text-gray-500">
            Nenhum pedido {{ props.status.replace('-', ' ') }} encontrado.
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</template>
